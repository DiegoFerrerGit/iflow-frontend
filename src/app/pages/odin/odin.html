<main class="w-full flex flex-col items-center pb-32">
    <app-banner class="w-full shrink-0"></app-banner>

    <div class="w-full max-w-6xl mx-auto px-6 mt-12 flex flex-col items-center">
        <!-- Incomes Section Header -->
        <div class="w-full flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white tracking-wide uppercase">Fuentes de Ingreso</h2>
            @if (incomes.length > 0) {
            <button (click)="openModal()"
                class="flex items-center gap-2 bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-xl transition-colors text-sm font-bold border border-primary/20">
                <span class="material-symbols-outlined text-[18px]">add</span>
                Añadir fuente
            </button>
            }
        </div>

        <!-- Incomes Grid -->
        <div class="w-full grid grid-cols-1 md:grid-cols-3 gap-6 relative z-20" cdkDropList
            (cdkDropListDropped)="drop($event)">
            @for (income of incomes; track income.id) {
            <app-income-card cdkDrag [income]="income" (delete)="promptDelete(income)"
                (edit)="openModal(income)"></app-income-card>
            } @empty {
            <div class="col-span-1 md:col-span-3 flex justify-center w-full py-8">
                <div (click)="openModal()"
                    class="w-full max-w-[340px] h-[220px] rounded-2xl border-2 border-dashed border-primary/30 bg-primary/5 hover:bg-primary/10 hover:border-primary/50 flex flex-col items-center justify-center text-primary/70 hover:text-primary transition-all duration-300 cursor-pointer shadow-lg hover:shadow-[0_0_30px_rgba(168,85,247,0.15)] hover:-translate-y-1 group">
                    <div
                        class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                        <span class="material-symbols-outlined text-[32px]">add</span>
                    </div>
                    <span class="font-black tracking-widest uppercase text-sm">Añadir fuente</span>
                </div>
            </div>
            }
        </div>

        <!-- Incomes to Pool Flow -->
        <div class="w-full max-w-2xl mx-auto -mt-3 relative z-10 flex justify-center py-6 h-[120px] overflow-visible">
            <svg viewBox="0 0 1000 120" class="w-[100%] h-full overflow-visible absolute top-0"
                preserveAspectRatio="none">
                <defs>
                    <filter id="glow-flow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="4" result="blur" />
                        <feMerge>
                            <feMergeNode in="blur" />
                            <feMergeNode in="SourceGraphic" />
                        </feMerge>
                    </filter>
                    <style>
                        .animated-path {
                            stroke-dasharray: 8 12;
                            animation: dash-flow 2s linear infinite;
                        }

                        @keyframes dash-flow {
                            to {
                                stroke-dashoffset: -100;
                            }
                        }
                    </style>
                </defs>

                @for (income of incomes; track income; let i = $index) {
                <!-- Background Track -->
                <path
                    [attr.d]="'M ' + (((1000 / incomes.length) * i) + ((1000 / incomes.length) / 2)) + ' 0 C ' + (((1000 / incomes.length) * i) + ((1000 / incomes.length) / 2)) + ' 60, 500 60, 500 120'"
                    fill="none" stroke="#22c55e" stroke-width="2" opacity="0.15" stroke-linecap="round" />

                <!-- Animated flow -->
                <path
                    [attr.d]="'M ' + (((1000 / incomes.length) * i) + ((1000 / incomes.length) / 2)) + ' 0 C ' + (((1000 / incomes.length) * i) + ((1000 / incomes.length) / 2)) + ' 60, 500 60, 500 120'"
                    fill="none" stroke="#22c55e" stroke-width="3" class="animated-path" filter="url(#glow-flow)"
                    stroke-linecap="round" />

                <!-- Source Dots -->
                <circle [attr.cx]="(((1000 / incomes.length) * i) + ((1000 / incomes.length) / 2))" cy="0" r="5"
                    fill="#4ade80" filter="url(#glow-flow)" />
                }

                <!-- Target Pool Entry Dot -->
                <circle cx="500" cy="120" r="7" fill="#4ade80" filter="url(#glow-flow)" />
            </svg>
        </div>

        <!-- Total Pool Central Card Match Stitch -->
        <div class="w-full max-w-4xl mx-auto relative mt-8">
            <div
                class="w-full h-full bg-[#110e15] border border-[#2d7a5d] rounded-[32px] p-12 relative z-20 flex flex-col md:flex-row items-center gap-16 overflow-hidden shadow-[0_0_20px_rgba(45,122,93,0.3)]">
                <!-- Inner soft highlight -->
                <div
                    class="absolute inset-0 bg-gradient-to-br from-[#2d7a5d]/10 to-transparent pointer-events-none rounded-[32px] z-30">
                </div>

                <div class="flex flex-col items-center md:items-start shrink-0">
                    <h3 class="text-slate-400 text-xs font-black tracking-[0.2em] uppercase mb-6 ml-2">Distribución</h3>

                    <div class="relative w-56 h-56 flex items-center justify-center">
                        <!-- SVG Donut Chart -->
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 120 120">
                            <!-- Background track -->
                            <circle cx="60" cy="60" r="50" fill="none" class="stroke-white/5" stroke-width="10">
                            </circle>

                            <!-- Purple Segment 55% -->
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#6d489b" stroke-width="10"
                                stroke-dasharray="172.78 314.15" stroke-dashoffset="0"></circle>

                            <!-- Green Segment 30% -->
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#2d7a5d" stroke-width="10"
                                stroke-dasharray="94.24 314.15" stroke-dashoffset="-172.78"></circle>

                            <!-- Pink Segment 15% -->
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#b35c75" stroke-width="10"
                                stroke-dasharray="47.12 314.15" stroke-dashoffset="-267.02"></circle>
                        </svg>

                        <div class="absolute inset-0 flex flex-col items-center justify-center text-center mt-2">
                            <span class="text-slate-400 text-[10px] font-black tracking-widest uppercase mb-1">Total
                                Pool</span>
                            <span class="text-white text-[32px] font-black tracking-tighter">$14,500</span>
                        </div>
                    </div>
                </div>

                <!-- Right side: Information -->
                <div class="flex flex-col w-full">
                    <h3 class="text-slate-400 text-[11px] font-black tracking-[0.2em] uppercase mb-2">Total de
                        Ingresos
                    </h3>
                    <div class="flex items-baseline gap-3 mb-8">
                        <span class="text-white text-[64px] leading-none font-black tracking-tighter">
                            $14,500
                        </span>
                        <span class="text-slate-500 text-2xl font-black tracking-wide">USD</span>
                    </div>

                    <div class="w-full h-px bg-white/10 mb-8 mt-2"></div>

                    <p class="text-slate-300 text-[17px] leading-relaxed max-w-lg font-medium">
                        Este es el pool total de fondos combinados, listo para ser distribuido a las Cajas de
                        Asignación.
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Delete Confirmation Modal -->
@if (incomeToDelete) {
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div
        class="bg-sidebar-bg border border-white/10 rounded-2xl p-8 max-w-sm w-full shadow-2xl flex flex-col items-center text-center">
        <div class="w-16 h-16 rounded-full bg-logout-coral/10 text-logout-coral flex items-center justify-center mb-6">
            <span class="material-symbols-outlined text-3xl">delete_forever</span>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">Eliminar Fuente</h3>
        <p class="text-slate-400 text-sm mb-8">¿Estás seguro de que deseas eliminar la fuente <span
                class="text-white font-bold">"{{ incomeToDelete.name }}"</span>? Esta acción no se puede deshacer.</p>

        <div class="flex gap-4 w-full">
            <button (click)="cancelDelete()"
                class="flex-1 px-4 py-3 rounded-xl border border-white/10 text-slate-300 font-bold hover:bg-white/5 transition-colors">
                Cancelar
            </button>
            <button (click)="confirmDelete()"
                class="flex-1 px-4 py-3 rounded-xl bg-logout-coral/90 hover:bg-logout-coral text-white font-bold transition-colors shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                Eliminar
            </button>
        </div>
    </div>
</div>
}

<!-- Add/Edit Income Modal -->
@if (isModalOpen) {
<app-income-form-modal [initialIncome]="incomeToEdit" (close)="closeModal()" (save)="onSaveIncome($event)">
</app-income-form-modal>
}